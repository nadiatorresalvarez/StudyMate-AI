@page "/documentos"
@using Microsoft.AspNetCore.Authorization
@using StudyMateAI.Client.DTOs.Document
@using StudyMateAI.Client.Services.Interfaces
@using StudyMateAI.Client.Components
@inject IDocumentService DocumentService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@attribute [Authorize]

@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using Variant = MudBlazor.Variant
@using MaxWidth = MudBlazor.MaxWidth
@using Breakpoint = MudBlazor.Breakpoint

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Mis Documentos</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.CloudUpload"
                   OnClick="OpenUploadDialog">
            Subir Nuevo
        </MudButton>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else if (_documents.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No has subido documentos aún.</MudAlert>
    }
    else
    {
        <div class="d-none d-md-block">
            <MudTable Items="_documents" Hover="true" Elevation="3">
                <HeaderContent>
                    <MudTh>Tipo</MudTh>
                    <MudTh>Nombre</MudTh>
                    <MudTh>Materia</MudTh>
                    <MudTh>Estado</MudTh>
                    <MudTh>Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Tipo"><MudIcon Icon="@GetIconForType(context.FileType)" Color="Color.Secondary" /></MudTd>
                    <MudTd DataLabel="Nombre">
                        <MudLink Href="@($"documentos/{context.Id}")" Typo="Typo.body1" Style="font-weight: bold;">@context.OriginalFileName</MudLink>
                        <MudText Typo="Typo.caption" Class="d-block">Subido: @context.CreatedAt.ToShortDateString()</MudText>
                    </MudTd>
                    <MudTd DataLabel="Materia"><MudChip T="string" Variant="Variant.Text" Color="Color.Primary">@context.SubjectName</MudChip></MudTd>
                    <MudTd DataLabel="Estado">
                        <MudChip T="string" Color="@GetStatusColor(context.ProcessingStatus)" Size="Size.Small">@context.ProcessingStatus</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Acciones">
                        <MudTooltip Text="Ver Detalle"><MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small" Href="@($"documentos/{context.Id}")" Class="mr-2" /></MudTooltip>
                        <MudTooltip Text="Eliminar"><MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteDocument(context.Id))" /></MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>

        <!-- 2. VISTA DE TARJETAS PARA MÓVIL (Oculta desde 'md' en adelante) -->
        <div class="d-md-none">
            <MudList T="DocumentResponseDto"> 
                @foreach (var doc in _documents)
                {
                    <MudCard Outlined="true" Class="mb-3">
                        <MudListItem T="DocumentResponseDto" OnClick="@(() => NavManager.NavigateTo($"/documentos/{doc.Id}"))">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@GetIconForType(doc.FileType)" Color="Color.Secondary" Class="mr-4"/>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">@doc.OriginalFileName</MudText>
                                    <MudText Typo="Typo.caption">@doc.SubjectName</MudText>
                                </div>
                                <MudChip T="string" Color="@GetStatusColor(doc.ProcessingStatus)" Size="Size.Small">@doc.ProcessingStatus</MudChip>
                            </div>
                        </MudListItem>
                    </MudCard>
                }
            </MudList>
        </div>
    }
</MudContainer>

@code {
    private List<DocumentResponseDto> _documents = new();
    private bool _loading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        _loading = true;
        try
        {
            _documents = await DocumentService.GetAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenUploadDialog()
    {
        var dialog = DialogService.Show<UploadDialog>("Subir Documento");
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // ✅ CORREGIDO: línea 138 - Manejo seguro de null
            dynamic data = result.Data;
            IBrowserFile? file = data?.File;
            int subjectId = data?.SubjectId != null ? (int)data.SubjectId : 0;

            if (file != null && subjectId > 0)
            {
                try
                {
                    Snackbar.Add("Subiendo archivo...", Severity.Info);
                    await DocumentService.UploadDocument(file, subjectId);
                    Snackbar.Add("Archivo subido. Procesando con IA...", Severity.Success);
                    await LoadDocuments();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Error al subir: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task DeleteDocument(int id)
    {
        bool? result = await DialogService.ShowMessageBox("Borrar", "¿Eliminar este documento?", yesText: "Sí", cancelText: "No");
        if (result == true)
        {
            await DocumentService.Delete(id);
            await LoadDocuments();
        }
    }

    private string GetIconForType(string type)
    {
        return type.ToUpper() switch
        {
            "PDF" => Icons.Material.Filled.PictureAsPdf,
            "DOCX" => Icons.Material.Filled.Description,
            "TXT" => Icons.Material.Filled.TextSnippet,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Completed" => Color.Success,
            "Failed" => Color.Error,
            _ => Color.Warning
        };
    }
}