@page "/documentos/{Id:int}"
@using System.Text.Json
@using StudyMateAI.Client.Components
@using StudyMateAI.Client.DTOs.Diagrams
@using StudyMateAI.Client.DTOs.Document
@using StudyMateAI.Client.DTOs.Flashcards
@using StudyMateAI.Client.DTOs.Quiz
@using StudyMateAI.Client.Services
@using StudyMateAI.Client.Services.Interfaces
@using StudyMateAI.Client.Services.Implementations
@inject IDocumentService DocumentService
@inject StudyService StudyService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

@inject QuizService QuizService
@inject IDialogService DialogService
@inject ISummaryService SummaryService

@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using Variant = MudBlazor.Variant
@using MaxWidth = MudBlazor.MaxWidth

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_document == null)
    {
        <!-- Estado de Carga -->
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        <MudText Align="Align.Center" Class="mt-4">Cargando documento...</MudText>
    }
    else
    {
        <!-- Encabezado -->
        <div class="d-flex align-center mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="documentos" Color="Color.Inherit" Class="mr-3" />
            <div>
                <MudText Typo="Typo.h4">@_document.OriginalFileName</MudText>
            </div>
        </div>

        <!-- Pesta√±as -->
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" KeepPanelsAlive="true">
            
            <!-- 1. RESUMEN -->
            <MudTabPanel Text="Resumen" Icon="@Icons.Material.Filled.Article">
                <MudGrid>
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.h6" Class="mb-4">Generar con IA</MudText>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mb-2"
                                       OnClick="@(() => LoadSummary("brief"))" Disabled="_loadingSummary">Breve</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" Class="mb-2"
                                       OnClick="@(() => LoadSummary("detailed"))" Disabled="_loadingSummary">Detallado</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" FullWidth="true"
                                       OnClick="@(() => LoadSummary("concepts"))" Disabled="_loadingSummary">Conceptos</MudButton>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="9">
                        @if (_loadingSummary)
                        {
                            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
                            <MudText Align="Align.Center" Class="mt-2">Analizando documento...</MudText>
                        }
                        else if (string.IsNullOrEmpty(_summaryText))
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">Selecciona un tipo de resumen para comenzar.</MudAlert>
                        }
                        else
                        {
                            <div class="d-flex justify-end mb-4">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Download"
                                           OnClick="DownloadSummary"
                                           Disabled="_downloadingSummary">
                                    @if (_downloadingSummary)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        <span>Descargando...</span>
                                    }
                                    else
                                    {
                                        <span>üì• Descargar Resumen</span>
                                    }
                                </MudButton>
                            </div>
                            <MudPaper Class="pa-6" Elevation="1" Style="background-color: #FAFAFA; border-left: 4px solid #7986CB;">
                                <MudText Typo="Typo.body1" Style="white-space: pre-line; line-height: 1.6;">
                                    @((MarkupString)(_summaryText ?? ""))
                                </MudText>
                            </MudPaper>
                        }
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <!-- 2. FLASHCARDS -->
            <MudTabPanel Text="Flashcards" Icon="@Icons.Material.Filled.ViewCarousel">
                @if (_loadingFlashcards)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Secondary" />
                    <MudText Class="mt-2">Generando tarjetas...</MudText>
                }
                else if (_flashcards == null || _flashcards.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">Este documento no tiene tarjetas a√∫n.</MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.AutoAwesome" 
                               OnClick="GenerateFlashcards" Size="Size.Large">
                        Generar Flashcards con IA
                    </MudButton>
                }
                else
                {
                    <div class="d-flex justify-space-between align-center mb-4">
                        <MudButton StartIcon="@Icons.Material.Filled.Refresh" OnClick="GenerateFlashcards" Color="Color.Default">
                            Regenerar
                        </MudButton>
                        <MudText Typo="Typo.body2" Color="Color.Inherit">
                            @_flashcards.Count tarjeta@(_flashcards.Count != 1 ? "s" : "")
                        </MudText>
                    </div>
                    
                    <!-- Componente interactivo de Flashcards -->
                    <FlashcardViewer Flashcards="_flashcards" OnFlashcardReviewed="HandleFlashcardReviewed" />
                }
            </MudTabPanel>
            
            <!-- CUESTIONARIO -->
            <MudTabPanel Text="Cuestionario" Icon="@Icons.Material.Filled.Quiz">
                <div class="d-flex flex-column align-center justify-center text-center pa-10">
                    <MudIcon Icon="@Icons.Material.Filled.Quiz" Color="Color.Primary" Size="Size.Large" Class="mb-4" />
                    <MudText Typo="Typo.h5" GutterBottom="true">Prueba tus conocimientos</MudText>
                    <MudText Class="mb-6">Genera un cuestionario basado en el documento para evaluar tu comprensi√≥n.</MudText>
                    
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               Size="Size.Large" 
                               OnClick="StartQuiz"
                               Disabled="_startingQuiz">
                        @if (_startingQuiz)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            <span>Generando...</span>
                        }
                        else
                        {
                            <span>Empezar Cuestionario</span>
                        }
                    </MudButton>
                </div>
            </MudTabPanel>

            <!-- MAPAS -->
            <MudTabPanel Text="Mapas" Icon="@Icons.Material.Filled.Hub">
                @if (_loadingMap)
                {
                    <div class="d-flex flex-column align-center">
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                        <MudText Class="mt-2">La IA est√° dibujando las conexiones...</MudText>
                    </div>
                }
                else if (string.IsNullOrWhiteSpace(_displayNodesJson))
                {
                    <div class="d-flex flex-column align-center justify-center text-center pa-10">
                        <MudIcon Icon="@Icons.Material.Filled.Hub" Size="Size.Large" Class="mb-4" />
                        <MudText Typo="Typo.h5" GutterBottom="true">Visualiza las Conexiones</MudText>
                        <MudText Class="mb-6">Genera un mapa mental o conceptual para entender las relaciones clave.</MudText>
                        
                        <div class="d-flex gap-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="GenerateConceptMap">
                                Generar Mapa Conceptual
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Large" OnClick="GenerateMindMap">
                                Generar Mapa Mental
                            </MudButton>
                        </div>
                    </div>
                }
                else
                {
                    <div class="d-flex justify-end mb-2">
                        <MudButton OnClick="ClearMap" StartIcon="@Icons.Material.Filled.Clear">Limpiar y Regenerar</MudButton>
                    </div>
                    <MermaidViewer NodesJson="@_displayNodesJson" EdgesJson="@_displayEdgesJson" />
                }
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }

    private DocumentResponseDto? _document;
    private string _summaryText = "";
    private bool _loadingSummary = false;
    private bool _downloadingSummary = false;
    private int? _currentSummaryId = null;
    private string _currentSummaryType = "brief";
    private bool _startingQuiz = false;
    
    private bool _loadingMap = false;
    
    private string? _displayNodesJson;
    private string? _displayEdgesJson;
    
    private List<FlashcardResponseDto> _flashcards = new(); 
    private bool _loadingFlashcards = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _document = await DocumentService.GetById(Id); 
            
            await LoadFlashcards();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.ToString());
            Snackbar.Add("Error cargando documento", Severity.Error);
        }
    }

    private async Task LoadSummary(string type)
    {
        _loadingSummary = true;
        try
        {
            _summaryText = await StudyService.GenerateSummary(Id, type);
            _currentSummaryType = type;
            Snackbar.Add("Resumen generado", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingSummary = false;
        }
    }

    private async Task LoadFlashcards()
    {
        try
        {
            var cards = await StudyService.GetFlashcards(Id);
            if (cards != null)
            {
                _flashcards = cards;
            }
        }
        catch (Exception) { /* Ignorar errores silenciosos de carga inicial */ }
    }

    private async Task GenerateFlashcards()
    {
        _loadingFlashcards = true;
        try
        {
            await StudyService.GenerateFlashcards(Id);
            await LoadFlashcards();
            Snackbar.Add("Flashcards generadas", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingFlashcards = false;
        }
    }

    private Color GetDifficultyColor(string? difficulty)
    {
        if (string.IsNullOrEmpty(difficulty)) return Color.Default;

        return difficulty.ToLower() switch
        {
            "easy" => Color.Success,
            "medium" => Color.Warning,
            "hard" => Color.Error,
            _ => Color.Default
        };
    }

    private async Task StartQuiz()
    {
        _startingQuiz = true;
        try
        {
            var quizForAttempt = await QuizService.GenerateQuiz(Id);

            var parameters = new DialogParameters { ["Quiz"] = quizForAttempt };
            var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
            var dialog = DialogService.Show<TakeQuiz>("Cuestionario", parameters, options);

            var result = await dialog.Result;

            // ‚úÖ CORREGIDO: Manejo seguro de null
            if (!result.Canceled && result.Data != null)
            {
                var quizResult = (QuizAttemptResultDto)result.Data;
                var resultParams = new DialogParameters 
                { 
                    ["Result"] = quizResult,
                    ["QuizId"] = quizForAttempt.QuizId
                };
                var resultOptions = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
                DialogService.Show<QuizResult>("Resultado del Cuestionario", resultParams, resultOptions);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al iniciar el quiz: {ex.Message}", Severity.Error);
        }
        finally
        {
            _startingQuiz = false;
        }
    }
    
    private async Task GenerateConceptMap()
    {
        _loadingMap = true;
        ClearMap();
        try
        {
            var result = await StudyService.GenerateConceptMap(Id);

            _displayNodesJson = JsonSerializer.Serialize(result.Nodes);
            _displayEdgesJson = JsonSerializer.Serialize(result.Edges);
            
            Snackbar.Add("Mapa Conceptual generado", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generando mapa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingMap = false;
        }
    }
    
    private async Task GenerateMindMap()
    {
        _loadingMap = true;
        ClearMap();
        try
        {
            var result = await StudyService.GenerateMindMap(Id);

            _displayNodesJson = result.NodesJson;
            _displayEdgesJson = null;
            
            Snackbar.Add("Mapa Mental generado", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generando mapa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingMap = false;
        }
    }
    
    private void ClearMap()
    {
        _displayNodesJson = null;
        _displayEdgesJson = null;
    }

    private async Task HandleFlashcardReviewed((int CardId, int Quality) result)
    {
        // Este m√©todo se ejecuta cuando una flashcard es evaluada
        // Se puede usar para analytics, actualizar UI, etc.
        System.Diagnostics.Debug.WriteLine($"Flashcard {result.CardId} evaluada con calidad: {result.Quality}");
    }

    private async Task DownloadSummary()
    {
        _downloadingSummary = true;
        try
        {
            if (_document == null || _document.SummaryCount == 0)
            {
                Snackbar.Add("No hay resumen disponible para descargar", Severity.Warning);
                return;
            }

            // Obtener el ID m√°s reciente del resumen (asumimos que el backend retorna el √∫ltimo)
            // Para una implementaci√≥n completa, necesitar√≠as guardar el SummaryId cuando se genera
            // Por ahora, usamos un valor placeholder que deber√≠as actualizar seg√∫n tu backend
            var summaryId = _currentSummaryId ?? 1; // Esto deber√≠a venir del backend

            var fileBytes = await SummaryService.DownloadSummaryAsync(summaryId);
            
            if (fileBytes != null && fileBytes.Length > 0)
            {
                // Crear nombre de archivo
                var fileName = $"Resumen-{_document.OriginalFileName.Replace(" ", "_")}.docx";

                // Llamar a la funci√≥n JavaScript para descargar
                await JSRuntime.InvokeVoidAsync("downloadDocxFile", fileName, fileBytes);
                Snackbar.Add("Resumen descargado correctamente", Severity.Success);
            }
            else
            {
                Snackbar.Add("Error: No se pudo obtener el archivo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error descargando resumen: {ex.Message}", Severity.Error);
            System.Diagnostics.Debug.WriteLine($"Error en DownloadSummary: {ex}");
        }
        finally
        {
            _downloadingSummary = false;
        }
    }
}