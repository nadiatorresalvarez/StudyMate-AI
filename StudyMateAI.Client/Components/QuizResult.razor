@using StudyMateAI.Client.DTOs.Quiz
@using StudyMateAI.Client.Services.Interfaces
@using Size = MudBlazor.Size
@using Microsoft.JSInterop
@inject IQuizDownloadService QuizDownloadService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime


<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Grading" Class="mr-3" />
            <MudText Typo="Typo.h6">Resultados: @Result.QuizTitle</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <div class="d-flex justify-center align-center pa-4">
            <!-- âœ… CORREGIDO: MudProgressCircular no acepta ChildContent -->
            <div class="position-relative d-flex justify-center align-center mr-6">
                <MudProgressCircular Color="Color.Success" Value="@((int)Result.ScorePercent)" Size="Size.Large" />
                <div class="position-absolute" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <MudText Typo="Typo.h5">@($"{Result.ScorePercent:F0}%")</MudText>
                </div>
            </div>
            <div>
                <MudText Typo="Typo.h6">Puntaje: @Result.CorrectAnswers / @Result.TotalQuestions</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Â¡Sigue estudiando para mejorar!</MudText>
            </div>
        </div>
        
        <MudDivider Class="my-4"/>

        <MudExpansionPanels MultiExpansion="true">
            @foreach (var q in Result.Questions)
            {
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@(q.IsCorrect ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                                     Color="@(q.IsCorrect ? Color.Success : Color.Error)" Class="mr-3"/>
                            <MudText>@q.QuestionText</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudList T="string">
                            @foreach(var option in q.Options)
                            {
                                if (option == q.CorrectAnswer)
                                {
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                        @option (Correcta)
                                    </MudListItem>
                                }
                                else if (option == q.SelectedOption && !q.IsCorrect)
                                {
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                        @option (Tu respuesta)
                                    </MudListItem>
                                }
                                else
                                {
                                    <MudListItem T="string">@option</MudListItem>
                                }
                            }
                        </MudList>
                    </ChildContent>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="DownloadQuizPdf" 
                   Color="Color.Info" 
                   Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Download"
                   Disabled="_downloadingPdf">
            @if (_downloadingPdf)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Descargando...</span>
            }
            else
            {
                <span>ðŸ“¥ Descargar PDF</span>
            }
        </MudButton>
        <MudButton OnClick="Close" Color="Color.Primary" Variant="Variant.Filled">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public QuizAttemptResultDto Result { get; set; } = new();
    [Parameter] public int? QuizId { get; set; }

    private bool _downloadingPdf = false;

    void Close() => MudDialog.Close(DialogResult.Ok(true));

    private async Task DownloadQuizPdf()
    {
        _downloadingPdf = true;
        try
        {
            if (!QuizId.HasValue || QuizId <= 0)
            {
                Snackbar.Add("No se pudo identificar el cuestionario para descargar", Severity.Warning);
                return;
            }

            var fileBytes = await QuizDownloadService.DownloadQuizPdfAsync(QuizId.Value);
            
            if (fileBytes != null && fileBytes.Length > 0)
            {
                // Crear nombre de archivo
                var fileName = $"Cuestionario-{Result.QuizTitle.Replace(" ", "_")}.pdf";

                // Llamar a la funciÃ³n JavaScript para descargar
                await JSRuntime.InvokeVoidAsync("downloadPdfFile", fileName, fileBytes);
                Snackbar.Add("Cuestionario descargado correctamente", Severity.Success);
            }
            else
            {
                Snackbar.Add("Error: No se pudo obtener el archivo PDF", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error descargando PDF: {ex.Message}", Severity.Error);
            System.Diagnostics.Debug.WriteLine($"Error en DownloadQuizPdf: {ex}");
        }
        finally
        {
            _downloadingPdf = false;
        }
    }
}